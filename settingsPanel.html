<!DOCTYPE html>
<html>
<head>
  <style>
    html, body {
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f1eb;
      color: #3d2914;
      box-sizing: border-box;
      width: 100%;
      min-width: 0;
      max-width: 300px;
    }

    .header {
      background: #d2691e;
      color: #fff;
      padding: 16px 0 14px 0;
      font-size: 18px;
      text-align: center;
      font-weight: 600;
      border-bottom: 1px solid #e0e0e0;
      letter-spacing: 0.2px;
      box-shadow: 0 2px 8px rgba(210, 105, 30, 0.08);
    }

    .tabs {
      display: flex;
      background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
      color: #fff;
      border-bottom: 1px solid #e0e0e0;
      font-weight: 500;
    }

    .tab {
      padding: 10px 0;
      cursor: pointer;
      flex: 1;
      text-align: center;
      font-weight: 500;
      font-size: 14px;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-bottom 0.2s, background 0.2s;
      background: none;
      color: #fff;
    }

    .tab.active {
      color: #d2691e;
      border-bottom: 2.5px solid #d2691e;
      background: #fff;
    }

    .tab:not(.active):hover {
      background: #cd853f;
      color: #fff;
    }

    .content {
      padding: 16px 10px 8px 10px;
      display: none;
      min-width: 0;
    }

    .content.active {
      display: block;
    }

    .section {
      margin-bottom: 18px;
      padding: 14px 10px 10px 10px;
      background: linear-gradient(135deg, #fff 0%, #faf8f3 100%);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(210, 105, 30, 0.04);
      border: 1px solid #e6d7c3;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #8b4513;
      border-bottom: 2px solid #d2691e;
      padding-bottom: 3px;
    }

    .section-description {
      font-size: 12px;
      color: #6b4423;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .section-description a {
      color: #d2691e;
      text-decoration: none;
      font-weight: 500;
    }

    .section-description a:hover {
      color: #b8860b;
      text-decoration: underline;
    }

    .form-group {
      margin-bottom: 10px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      color: #5d3317;
      font-size: 13px;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px 10px;
      border: 1.5px solid #e6d7c3;
      border-radius: 5px;
      font-size: 13px;
      box-sizing: border-box;
      background: #fff;
      transition: border-color 0.2s, box-shadow 0.2s;
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: #d2691e;
      box-shadow: 0 0 0 2px rgba(210, 105, 30, 0.08);
      background: #faf8f3;
    }

    .api-key-status {
      display: flex;
      align-items: center;
      margin-top: 6px;
      padding: 5px 8px;
      background: #f8f5f0;
      border-radius: 4px;
      border: 1px solid #e6d7c3;
      font-size: 12px;
      color: #6b4423;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
      box-shadow: 0 0 0 1px #fff;
    }

    .status-configured {
      background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
    }

    .status-not-configured {
      background: linear-gradient(135deg, #f44336 0%, #ff5722 100%);
    }

    .button-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    button {
      background: #d2691e;
      color: #fff;
      padding: 7px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 2px rgba(210, 105, 30, 0.08);
      margin: 0;
      min-width: 0;
      flex: 1 1 0;
      max-width: 100%;
    }

    button:hover {
      background: #b8860b;
    }

    button:active {
      background: #8b4513;
    }

    button.secondary {
      background: #ececec;
      color: #3d2914;
    }

    button.secondary:hover {
      background: #e6d7c3;
      color: #3d2914;
    }

    button.danger {
      background: #c44536;
      color: #fff;
    }

    button.danger:hover {
      background: #dc143c;
    }

    .notification {
      padding: 10px 12px;
      margin: 10px 0 8px 0;
      border-radius: 4px;
      display: none;
      font-weight: 500;
      border-left: 4px solid;
      font-size: 13px;
    }

    .notification.success {
      background-color: #e8f5e9;
      border-left: 4px solid #4caf50;
    }

    .notification.error {
      background-color: #ffebee;
      border-left: 4px solid #f44336;
    }

    .notification.update {
      background-color: #e3f2fd;
      border-left: 4px solid #2196f3;
      margin-bottom: 15px;
    }

    .help-content {
      line-height: 1.6;
      color: #3d2914;
      font-size: 13px;
    }

    .help-content h3 {
      color: #8b4513;
      margin-top: 18px;
      margin-bottom: 8px;
      font-weight: 600;
      border-bottom: 2px solid #d2691e;
      padding-bottom: 3px;
      font-size: 15px;
    }

    .help-content h4 {
      color: #a0522d;
      margin-top: 12px;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 13px;
    }

    .help-content code {
      background: linear-gradient(135deg, #f8f5f0 0%, #f0ebe1 100%);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      color: #8b4513;
      border: 1px solid #e6d7c3;
      font-size: 12px;
    }

    .help-content ul {
      padding-left: 18px;
    }

    .help-content li {
      margin-bottom: 4px;
    }

    .help-content a {
      color: #d2691e;
      text-decoration: none;
      font-weight: 500;
    }

    .help-content a:hover {
      color: #b8860b;
      text-decoration: underline;
    }

    /* Scrollbar styling for webkit browsers */
    ::-webkit-scrollbar {
      width: 7px;
    }

    ::-webkit-scrollbar-track {
      background: #f8f5f0;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #d2691e 0%, #cd853f 100%);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #b8860b 0%, #d2691e 100%);
    }
    .button-link-container {
      margin-top: 4px;
      text-align: right;
    }

    .replace-go-button{
      margin-top: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .text-to-cell-div {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      flex-direction: column;
    }

  </style>
</head>

<body>
  <div class="header">gpt4sheets Settings</div>

  <div id="update-notification" class="notification update" style="display:none;">
    A newer version of gpt4sheets is available. <a href="https://github.com/widgetlabs-ai/gpt4sheets" target="_blank">See what's new</a>
  </div>

  <div class="tabs">
    <div class="tab active" id="tab-api-keys">API Keys</div>
    <div class="tab" id="tab-preferences">Preferences</div>
    <div class="tab" id="tab-help">Help</div>
    <div class="tab" id="tab-utilities">Utilities</div>
  </div>

  <!-- API Keys Tab -->
  <div class="content active" id="content-api-keys">
    <div id="notification" class="notification"></div>
    
    <div class="section">
      <div class="section-title">Google Gemini API Key</div>
      <div class="section-description">
        Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
      </div>
      <div class="form-group">
        <input type="password" id="gemini-api-key" placeholder="Enter your Gemini API key">
        <div class="api-key-status" id="gemini-status">
          <div class="status-indicator status-not-configured"></div>
          <span>Not configured</span>
        </div>
      </div>
      <div class="button-row">
        <button onclick="saveAndTestApiKey('gemini')">Save</button>
        <button class="danger" onclick="removeApiKey('gemini')">Remove</button>
      </div>
      <div class="button-link-container">
        <a href="#" style="font-size:11px; color:#b8860b; text-decoration:underline;" onclick="testSavedKey('gemini'); return false;">Test saved key</a>
      </div>
    </div>

    <div class="section">
      <div class="section-title">OpenAI API Key</div>
      <div class="section-description">
        Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>
      </div>
      <div class="form-group">
        <input type="password" id="openai-api-key" placeholder="Enter your OpenAI API key">
        <div class="api-key-status" id="openai-status">
          <div class="status-indicator status-not-configured"></div>
          <span>Not configured</span>
        </div>
      </div>
      <div class="button-row">
        <button onclick="saveAndTestApiKey('openai')">Save</button>
        <button class="danger" onclick="removeApiKey('openai')">Remove</button>
      </div>
      <div style="margin-top:4px; text-align:right;">
        <a href="#" style="font-size:11px; color:#b8860b; text-decoration:underline;" onclick="testSavedKey('openai'); return false;">Test saved key</a>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Anthropic API Key</div>
      <div class="section-description">
        Get your API key from <a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a>
      </div>
      <div class="form-group">
        <input type="password" id="anthropic-api-key" placeholder="Enter your Anthropic API key">
        <div class="api-key-status" id="anthropic-status">
          <div class="status-indicator status-not-configured"></div>
          <span>Not configured</span>
        </div>
      </div>
      <div class="button-row">
        <button onclick="saveAndTestApiKey('anthropic')">Save</button>
        <button class="danger" onclick="removeApiKey('anthropic')">Remove</button>
      </div>
      <div style="margin-top:4px; text-align:right;">
        <a href="#" style="font-size:11px; color:#b8860b; text-decoration:underline;" onclick="testSavedKey('anthropic'); return false;">Test saved key</a>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Perplexity API Key</div>
      <div class="section-description">
        Get your API key from <a href="https://dashboard.perplexity.ai/" target="_blank">Perplexity Dashboard</a>
      </div>
      <div class="form-group">
        <input type="password" id="perplexity-api-key" placeholder="Enter your Perplexity API key">
        <div class="api-key-status" id="perplexity-status">
          <div class="status-indicator status-not-configured"></div>
          <span>Not configured</span>
        </div>
      </div>
      <div class="button-row">
        <button onclick="saveAndTestApiKey('perplexity')">Save</button>
        <button class="danger" onclick="removeApiKey('perplexity')">Remove</button>
      </div>
      <div style="margin-top:4px; text-align:right;">
        <a href="#" style="font-size:11px; color:#b8860b; text-decoration:underline;" onclick="testSavedKey('perplexity'); return false;">Test saved key</a>
      </div>
    </div>

    <div class="section">
      <div class="section-title">DeepSeek API Key</div>
      <div class="section-description">
        Get your API key from <a href="https://platform.deepseek.com/api_keys" target="_blank">DeepSeek Console</a>
      </div>
      <div class="form-group">
        <input type="password" id="deepseek-api-key" placeholder="Enter your DeepSeek API key">
        <div class="api-key-status" id="deepseek-status">
          <div class="status-indicator status-not-configured"></div>
          <span>Not configured</span>
        </div>
      </div>
      <div class="button-row">
        <button onclick="saveAndTestApiKey('deepseek')">Save</button>
        <button class="danger" onclick="removeApiKey('deepseek')">Remove</button>
      </div>
      <div style="margin-top:4px; text-align:right;">
        <a href="#" style="font-size:11px; color:#b8860b; text-decoration:underline;" onclick="testSavedKey('deepseek'); return false;">Test saved key</a>
      </div>
    </div>

  </div>

  <!-- Preferences Tab -->
  <div class="content" id="content-preferences">
    <div id="preferences-notification" class="notification"></div>
    
    <div class="section">
      <div class="section-title">Default Model</div>
      <div class="section-description">
        Choose the default AI model for AI_CALL() function
      </div>
      <div class="form-group">
        <select id="default-model">
          <!-- Options will be populated by JavaScript -->
        </select>
      </div>
      <div class="button-row">
        <button onclick="saveDefaultModel()">Save</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Default Temperature</div>
      <div class="section-description">
        Set the default creativity level (0 = focused, 1 = creative)
      </div>
      <div class="form-group">
        <input type="number" id="default-temperature" min="0" max="1" step="0.1" value="0">
      </div>
      <div class="button-row">
        <button onclick="saveDefaultTemperature()">Save</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Preferences</div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="include_search_results" name="include_search_results">
        <label class="form-check-label" for="include_search_results">
          Include Perplexity search results in responses
        </label>
        <div class="form-text">When using Perplexity models, append search results to the response</div>
      </div>
    </div>
  </div>

  <!-- Help Tab -->
  <div class="content" id="content-help">
    <div class="help-content">
      <h3>Available Functions</h3>
      
      <h4>=AI_CALL(prompt, [inputText])</h4>
      <p>Simple AI function that uses your default model and settings.</p>
      <ul>
        <li><strong>prompt</strong>: The question or instruction for the AI</li>
        <li><strong>inputText</strong> (optional): Additional context or data</li>
      </ul>
      <p>Example: <code>=AI_CALL("Summarize this text:", A1)</code></p>

      <h4>=AI_CALL_ADV(prompt, systemPrompt, inputText, temperature, modelName, outputType, overflow)</h4>
      <p>Advanced AI function with full control over parameters.</p>
      <ul>
        <li><strong>prompt</strong>: The question or instruction</li>
        <li><strong>systemPrompt</strong>: Context for the AI (e.g., "You are a helpful assistant")</li>
        <li><strong>inputText</strong>: Additional input data</li>
        <li><strong>temperature</strong>: Creativity level (0-1)</li>
        <li><strong>modelName</strong>: Specific model to use</li>
        <li><strong>outputType</strong>: "text", "list", or "matrix"</li>
        <li><strong>overflow</strong>: Whether to expand into adjacent cells</li>
      </ul>
      <p>Example: <code>=AI_CALL_ADV("List 5 colors", "You are helpful", "", 0, "gemini-2.0-flash", "list", true)</code></p>

      <h3>Getting API Keys</h3>
      <ul>
        <li><strong>Google Gemini</strong>: Visit <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></li>
        <li><strong>OpenAI</strong>: Visit <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></li>
        <li><strong>Anthropic</strong>: Visit <a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a></li>
        <li><strong>Perplexity</strong>: Visit <a href="https://www.perplexity.ai/account/api/keys" target="_blank">Perplexity Dashboard</a></li>
        <li><strong>DeepSeek</strong>: Visit <a href="https://platform.deepseek.com/api_keys" target="_blank">DeepSeek Dashboard</a></li>
      </ul>

      <h3>Available Models</h3>
      <ul>
        <li><strong>Gemini</strong>: gemini-2.0-flash, gemini-2.5-pro-exp-03-25</li>
        <li><strong>OpenAI</strong>: gpt-4o, gpt-4o-mini, o3-mini</li>
        <li><strong>Anthropic</strong>: claude-3.7-sonnet, claude-3.5-sonnet, claude-haiku</li>
        <li><strong>Perplexity</strong>: sonar, sonar-pro</li>
        <li><strong>DeepSeek</strong>: deepseek-chat, deepseek-reasoner</li>
      </ul>
    </div>
  </div>


  <!-- Utilities Tab -->
  <div class="content" id="content-utilities">
    <div class="utilities-content">
      <h3>Available Functions</h3>
        <div class="utility-dropdown-group">
          <select id="utility-action">
            <option selected disabled value="-1">Choose an action...</option>
            <option value="1">Replace Select Formulas ‚Üí Values</option>
            <option value="2">Replace All Formulas ‚Üí Values</option>
            <option value="3">Replace Select Values ‚Üí Formulas</option>
            <option value="4">Replace All Values ‚Üí Formulas</option>
          </select>
          <div class="replace-go-button">
            <button onclick="run_selected_option()">Go</button>
          </div>
      </div>
      <div class="text-to-cell-div">
        <button onclick="listTxtFilesHelper()">üîç Find .txt Files in Drive</button>
        <select id="fileSelect"></select>
        <button onclick="insertTxtContent()">üìÑ Output File Text to Cell</button>
      </div>
    </div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove active class from all tabs and contents
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab
        this.classList.add('active');
        
        // Show corresponding content
        const contentId = 'content-' + this.id.replace('tab-', '');
        document.getElementById(contentId).classList.add('active');
      });
    });

    // Load settings on page load
    window.onload = function() {
      loadSettings();
      checkForUpdateDisplay();
    };

    function listTxtFilesHelper(){
      google.script.run.withSuccessHandler(populateFileSelect).listTxtFiles();
    }

    function populateFileSelect(files){
      const select = document.getElementById("fileSelect");
      select.innerHTML = "";

      const baseOption = document.createElement("option");
      baseOption.value = -1;
      baseOption.text = "-- Select a txt file --";
      select.add(baseOption);

      for(const file of files){
        const option = document.createElement("option");
        option.value = file.id;
        option.text = file.name;
        select.add(option);
      }
    }

    function run_selected_option() {
      const option = document.getElementById("utility-action").value;

      switch (option) {
        case "1":
          google.script.run.replace_selected_formulas_with_values();
          break;
        case "2":
          google.script.run.replace_all_formulas_with_values();
          break;
        case "3":
          google.script.run.replace_selected_values_with_formulas();
          break;
        case "4":
          google.script.run.replace_all_values_with_formulas();
          break;
        default:
          alert("Please choose an action.");
      }
    }
    
    function checkForUpdateDisplay() {
      google.script.run
        .withSuccessHandler(function(updateStatus) {
          const updateNotification = document.getElementById('update-notification');
          updateNotification.style.display = 'block'; // Always display notification
          
          if (updateStatus && updateStatus.hasUpdate) {
            updateNotification.innerHTML = 'A newer version of gpt4sheets is available. <a href="https://github.com/widgetlabs-ai/gpt4sheets" target="_blank">See what\'s new</a>';
            updateNotification.style.backgroundColor = '#e3f2fd';
            updateNotification.style.borderLeftColor = '#2196f3';
          } else {
            // Show "latest version" message but make it auto-disappear after 3 seconds
            updateNotification.innerHTML = 'You are on the latest version of gpt4sheets.';
            updateNotification.style.backgroundColor = '#e8f5e9';
            updateNotification.style.borderLeftColor = '#4caf50';
            
            // Auto-hide this notification after 3 seconds
            setTimeout(() => {
              updateNotification.style.display = 'none';
            }, 3000);
          }
        })
        .withFailureHandler(function(error) {
          console.error("Failed to check update status:", error);
          
          // Show default message on failure
          const updateNotification = document.getElementById('update-notification');
          updateNotification.style.display = 'block';
          updateNotification.innerHTML = 'Unable to check for updates.';
          updateNotification.style.backgroundColor = '#fff3e0';
          updateNotification.style.borderLeftColor = '#ff9800';
        })
        .checkForUpdates();
    }

    function loadSettings() {
      // Use new backend function to get grouped models
      google.script.run
        .withSuccessHandler(function(settings) {
          google.script.run
            .withSuccessHandler(function(modelGroups) {
              const modelSelect = document.getElementById('default-model');
              modelSelect.innerHTML = '';

              // Quick Select group
              if (modelGroups.quickSelect && modelGroups.quickSelect.length > 0) {
                const optGroupQuick = document.createElement('optgroup');
                optGroupQuick.label = 'Quick Select (Recommended)';
                modelGroups.quickSelect.forEach(model => {
                  const option = document.createElement('option');
                  option.value = model;
                  option.textContent = model;
                  if (model === settings.defaultModel) option.selected = true;
                  optGroupQuick.appendChild(option);
                });
                modelSelect.appendChild(optGroupQuick);
              }

              // All Models by provider
              if (modelGroups.all && Array.isArray(modelGroups.all)) {
                modelGroups.all.forEach(group => {
                  const optGroup = document.createElement('optgroup');
                  optGroup.label = group.provider + ' (All)';
                  group.models.forEach(model => {
                    // Avoid duplicate in quick select
                    if (modelGroups.quickSelect && modelGroups.quickSelect.includes(model)) return;
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    if (model === settings.defaultModel) option.selected = true;
                    optGroup.appendChild(option);
                  });
                  if (optGroup.children.length > 0) modelSelect.appendChild(optGroup);
                });
              }

              // Set temperature
              document.getElementById('default-temperature').value = settings.defaultTemperature;
              // Set include_search_results checkbox
              document.getElementById('include_search_results').checked = settings.include_search_results === true;
              // Update API key status
              updateApiKeyStatus();
            })
            .withFailureHandler(function(error) {
              showNotification('Error loading model list: ' + error.message, 'error');
              // Apply default temperature and update API key status on failure
              document.getElementById('default-temperature').value = 0; // Default temperature
              updateApiKeyStatus(); // Update API key status
            })
            .getAllModelsGrouped();
        })
        .withFailureHandler(function(error) {
          showNotification('Error loading settings: ' + error.message, 'error');
        })
        .getUserSettings();
    }

    function updateApiKeyStatus() {
      google.script.run
        .withSuccessHandler(function(status) {
          ['gemini', 'openai', 'anthropic', 'perplexity', 'deepseek'].forEach(provider => {
            const statusElement = document.getElementById(provider + '-status');
            const indicator = statusElement.querySelector('.status-indicator');
            const text = statusElement.querySelector('span');
            
            if (status[provider] && status[provider].configured) {
              indicator.className = 'status-indicator status-configured';
              text.textContent = 'Configured (' + status[provider].keyPreview + ')';
            } else {
              indicator.className = 'status-indicator status-not-configured';
              text.textContent = 'Not configured';
            }
          });
        })
        .getApiKeyStatus();
    }

    function saveAndTestApiKey(provider) {
      const apiKey = document.getElementById(provider + '-api-key').value.trim();
      if (!apiKey) {
        showNotification('Please enter an API key', 'error');
        return;
      }

      showNotification('Testing API key...', 'success');
      google.script.run
        .withSuccessHandler(function(testResult) {
          if (testResult.success) {
            // Only save if test passes
            google.script.run
              .withSuccessHandler(function(saveResult) {
                if (saveResult.success) {
                  showNotification('API key tested and saved successfully', 'success');
                  document.getElementById(provider + '-api-key').value = '';
                  updateApiKeyStatus();
                } else {
                  showNotification(saveResult.message, 'error');
                }
              })
              .withFailureHandler(function(error) {
                showNotification('Error saving API key: ' + error.message, 'error');
              })
              .setProviderApiKey(provider, apiKey);
          } else {
            showNotification('API key test failed: ' + testResult.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showNotification('Error testing API key: ' + error.message, 'error');
        })
        .testApiKey(provider, apiKey);
    }

    function testSavedKey(provider) {
      // Check if a saved key exists before testing
      const statusElement = document.getElementById(provider + '-status');
      const statusText = statusElement && statusElement.querySelector('span') ? statusElement.querySelector('span').textContent : '';
      if (!statusText || statusText === 'Not configured') {
        showNotification('No saved API key to test', 'error');
        return;
      }
      showNotification('Testing saved API key...', 'success');
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showNotification('Saved API key is valid', 'success');
          } else {
            showNotification('Saved API key test failed: ' + result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showNotification('Error testing saved API key: ' + error.message, 'error');
        })
        .testApiKey(provider, null);
    }

    function testApiKey(provider) {
      const apiKey = document.getElementById(provider + '-api-key').value.trim();
      if (!apiKey) {
        showNotification('Please enter an API key to test', 'error');
        return;
      }

      showNotification('Testing API key...', 'success');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showNotification(result.message, 'success');
          } else {
            showNotification(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showNotification('Error testing API key: ' + error.message, 'error');
        })
        .testApiKey(provider, apiKey);
    }

    function removeApiKey(provider) {
      if (!confirm('Are you sure you want to remove the ' + provider + ' API key?')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showNotification(result.message, 'success');
            updateApiKeyStatus();
          } else {
            showNotification(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showNotification('Error removing API key: ' + error.message, 'error');
        })
        .removeProviderApiKey(provider);
    }

    function saveDefaultModel() {
      const model = document.getElementById('default-model').value;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showNotification(result.message, 'success', 'preferences-notification');
          } else {
            showNotification(result.message, 'error', 'preferences-notification');
          }
        })
        .withFailureHandler(function(error) {
          showNotification('Error saving default model: ' + error.message, 'error', 'preferences-notification');
        })
        .setDefaultModel(model);
    }

    function saveDefaultTemperature() {
      const temperature = parseFloat(document.getElementById('default-temperature').value);
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showNotification(result.message, 'success', 'preferences-notification');
          } else {
            showNotification(result.message, 'error', 'preferences-notification');
          }
        })
        .withFailureHandler(function(error) {
          showNotification('Error saving default temperature: ' + error.message, 'error', 'preferences-notification');
        })
        .setDefaultTemperature(temperature);
    }

    function showNotification(message, type, elementId = 'notification') {
      const notification = document.getElementById(elementId);
      notification.textContent = message;
      notification.className = 'notification ' + type;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }

    // Add this inside your <script> tag, after loadSettings()
    document.getElementById('include_search_results').addEventListener('change', function() {
      const checked = this.checked;
      google.script.run
        .withSuccessHandler(function(result) {
          showNotification(result.message, 'success', 'preferences-notification');
        })
        .withFailureHandler(function(error) {
          showNotification('Error saving preferences: ' + error.message, 'error', 'preferences-notification');
        })
        .savePreferences(checked ? { include_search_results: true } : {});
    });
  </script>
  <div style="text-align:right; font-size:11px; color:#b8860b; margin: 14px 10px 6px 0;">
    Open source project by <a href="https://widgetlabs.ai" target="_blank" style="color:#d2691e; text-decoration:none;">Widgetlabs.ai</a>
  </div>
</body>
</html>